---
title: "Time Series Predictive Model"
author: "Ragdoll99"
date: "2022-10-27"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Time Series Predictive Model for demand of perishable food item. 

This is a project to showcase time series predictive modelling. 

Background: A local supermarket often face the issue of over or under production of one of its perishable house brand food item. There are times when the supermarket over produce the item and need to discard large quantity of the expired goods. On the other hand, when demand exceed supply, the supermarket is not maximising its profit.

The supermarket has engaged data scientist to create a forecasting model to avoid over or under production. The task is to create an appropriate time series predicitve model. 

#### Loading library

```{r message=FALSE}
library(knitr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(seasonal) 
library(fpp2)
library(forecast)
library(MLmetrics)
```

#### Loading Dataset

```{r}
df <- read.csv("../data/Q2_Perishable.csv")
head(df)
```

#### Convert to times series

Derive date in  the dataset

```{r}
df$date <- paste("01",df$Month,as.character(df$Year),sep="-")
df$date <- as.Date(df$date, "%d-%b-%Y")
df$date
```

\
as noticed, this is monthly data which started on 2017 Jan with 12 months in frequency. 
We can convert it to time series with ts function. 

```{r}
sales <- ts(df$Sales..in.thousands., frequency = 12, start = 2017)
sales
```

#### Data Exploration

Basic Plot

```{r}
autoplot(sales, main = "Perishable food items sales: 2017 - 2020")
```
\
```{r}
ggseasonplot(sales, main = "Seasonal Plot")
```
\
Decomposition of times series. 
```{r}
decomposed_sales_additive <- decompose(sales, type = "additive")
autoplot(decomposed_sales_additive)
```
\
In the decomposition chart there is 4 compononents:\
1. Original data\
2. Trend: calculated by moving average of data.\
3. Seasonal: original data subtract the trend then average the results by month.\
4. Remainder: take the data subtract the trend and the seasonal component.\ 

```{r}
decomposed_sales_multiplicative <- decompose(sales, type = "multiplicative")
autoplot(decomposed_sales_multiplicative)
```

\
Next, we split data to training and test set for building model and evaluate the errors. 

```{r}
#Create samples
training=window(sales, start = c(2017,1), end = c(2019,12))
test=window(sales, start = c(2020,1))
```


### Forecasting
#### Naive Method
This is the baseline model. Any forecasting method should be evaluated by being compared to this Naive method. 
It is based on the assumption that forecast for tomorrow is what we are observing today. 

```{r}
naive = snaive(training, h=length(test))
Naive_MAPE <- MAPE(naive$mean, test) * 100
Naive_MAPE
```

```{r}
plot(sales, col="blue", xlab="Year", ylab="Sales", main="Seasonal Naive Forecast", type='l') +
  lines(naive$mean, col="red", lwd=2)
```

#### Exponential Smoothing

The idea of exponential smoothing is to have a declining weight given to observations. The more recent an observation, the more importance it will have in our forecast

State Space Models: 

```{r}
ets_model = ets(training, allow.multiplicative.trend = TRUE)
summary(ets_model)
```
\ 
```{r}
ets_forecast = forecast(ets_model, h=length(test))
ETS_MAPE <- MAPE(ets_forecast$mean, test) *100
ETS_MAPE
```
\
The ETS is additive with a MAPE of 11.36 to our testing data

```{r}
plot(sales, col="blue", xlab="Year", ylab="Sales", main="ETS Forecast", type='l') +
  lines(ets_forecast$mean, col="red", lwd=2)
```
\
Double Seasonal Holt-Winters
ETS function is only allow for one seasonality. Sometimes, there could be multiple seasonality (e.g Monthly and yearly). 
For double seasonal holt-winters method, it allow for two seasonality, a smaller one repeated often and bigger one repeated less often. 
we will use quarterly (every 3 months) and Yearly (every 12 months) for DSHW two period of seasonal effects. 

```{r}
dshw_model = dshw(training, period1=3, period2 = 12, h=length(test))
DSHW_MAPE <- MAPE(dshw_model$mean, test)*100
DSHW_MAPE
```
```{r}
plot(sales, col="blue", xlab="Year", ylab="Sales", main="DSHW Forecast", type='l') +
  lines(dshw_model$mean, col="red", lwd=2)
```

#### BATS and TBATS
DSHW allow for two seasonality. However, in some complex timeseries, there could be more thatn 2. BATS and TBATS allow for multiple seasonalities. TBATS is a improvement of BATS that allows for multiple non-integer seasonality cycles.

```{r}
tbats_model = tbats(training)
tbats_forecast = forecast(tbats_model, h=length(test))
TBATS_MAPE <- MAPE(tbats_forecast$mean, test) * 100
TBATS_MAPE
```

```{r}
plot(sales, col="blue", xlab="Year", ylab="Sales", main="TBATS Forecast", type='l') +
  lines(tbats_forecast$mean, col="red", lwd=2)
```

#### ARIMA Model

ARIMA models contain:
1. AR(p) : autoregressive part of the model. 
2. Differencing(d) : lags
3. MA(q): forecast errors


We use auto.arima function to return the best estimated model.
```{r}
arima_optimal = auto.arima(training)
arima_optimal
```
\
To forecast using ARIMA model (SARIMA for seasonality), there is a sarima.for function. 
```{r}
library(astsa)
sarima_forecast = sarima.for(training, n.ahead=12,
                             p=0,d=0,q=0,P=0,D=1,Q=0,S=12, plot=FALSE)
SARIMA_MAPE <- MAPE(sarima_forecast$pred, test) * 100
SARIMA_MAPE
```

```{r}
plot(sales, col="blue", xlab="Year", ylab="Sales", main="SARIMA Forecast", type='l') +
  lines(sarima_forecast$pred, col="red", lwd=2)
```

### Model selection
We can combine all the MAPE for model selection: 

```{r}
Model <- c("Naive", "ETS","DSHW", "TBATS","SARIMA")
MAPE <- c(Naive_MAPE, ETS_MAPE, DSHW_MAPE, TBATS_MAPE, SARIMA_MAPE)

c.df <- data.frame(Model, MAPE)
c.df
```

\
In this study, Double Seasonal Holt-Winters with two season (quarterly -every 3 months and Yearly-every 12 months) give the lowest MAPE.

Review the forecast again: 




























